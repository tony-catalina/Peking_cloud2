<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="Content-Script-Type" content="text/javascript"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
    <meta name="renderer" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="keywords" content="spring cloud,çœ‹å®ˆæ‰€,æ‹˜ç•™æ‰€,æˆ’æ¯’æ‰€,å®‰åº·åŒ»é™¢,ç›‘ç®¡æ€»é˜Ÿ,å—äº¬å®‰å¨å¾·"/>
    <meta name="generator" content="${config.CLOUD_NAME!}"/>
    <meta name="author" content="306165699@qq.com"/>
    <meta name="copyright" content="www.njawd.com"/>

    <title>${config.CLOUD_DESC!}</title>
    <script src="./js/layui.js" type="text/javascript" charset="utf-8"></script>
    <script src="./js/lib/jquery-1.8.0.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="./js/css/layui.css"/>
    <link href="./images/common/favicon.ico" rel="Shortcut Icon"/>
    <link href="./js/lib/picasa/style/style.css" rel="stylesheet"/>
    <link href="./style/common.css" rel="stylesheet"/>
    <link href="./style/font-awesome/css/font-awesome.css" rel="stylesheet"/>

    <!--[if IE 7]>
    <link rel="stylesheet" href="./style/font-awesome/css/font-awesome-ie7.css"/>
    <![endif]-->

    <link rel="stylesheet" href="./style/skin/base/app_desktop.css"/>
    <link rel="stylesheet" href="./style/skin/${userconfig.theme}.css" id='link_css_list'/>

</head>
<body style="overflow: hidden;" oncontextmenu="return core.contextmenu();" id="page_desktop">
<div style="width: 100%;height: 100%;pointer-events: none;opacity:0;z-index:99999998;position: fixed;" id="winds"></div>
<%include("../common/navbar.html"){}%>
<%include("../desktop/desktopmain.html"){}%>
<%include("../desktop/startbar.html"){}%>
<%include("../desktop/menuwin.html"){}%>
<input type="hidden" value="${userJh}" id="userJh"/>
<script type="text/javascript" src="./js/lib/seajs/sea.js"></script>
<%include("../user/common_js.html"){}%>

<script type="text/javascript">
    //socket é…ç½®===================================
    var msgs = '';
    var c = 0;

    function showLogin() {
        console.log("ç§’", c++);
    }

    layui.use('layim', function (layim) {
        WEB_SOCKET_SWF_LOCATION = "./js/swfobject.js";
        WEB_SOCKET_DEBUG = true;
        var lockReconnect = false;//é¿å…é‡å¤è¿æ¥
        var userJh = $("#userJh").val();
        var wsUrl = "ws://${config.web_host}/websocket/" + userJh;
        var ws;
        var tt;

        function createWebSocket() {
            try {
                if ('WebSocket' in window) {
                    console.log("å½“å‰æµè§ˆå™¨æ”¯æŒwebsocket=========")
                    ws = new WebSocket(wsUrl);
                    init();
                }
                else {
                    layer.msg("ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒwebsocketï¼");
                }


            } catch (e) {
                console.log('catch');
                reconnect(wsUrl);
            }
        }

        function init() {
            ws.onclose = function () {
                console.log('é“¾æ¥å…³é—­');
                reconnect(wsUrl);
            };
            ws.onerror = function () {
                console.log('å‘ç”Ÿå¼‚å¸¸äº†');
                reconnect(wsUrl);
            };
            ws.onopen = function () {
                //å¿ƒè·³æ£€æµ‹é‡ç½®
                console.log("è¿æ¥æˆåŠŸ=========")
                heartCheck.start();
            };
            ws.onmessage = function (event) {
                //æ‹¿åˆ°ä»»ä½•æ¶ˆæ¯éƒ½è¯´æ˜å½“å‰è¿æ¥æ˜¯æ­£å¸¸çš„
                console.log('æ¥æ”¶åˆ°æ¶ˆæ¯');
                setMessageInnerHTML(event.data)
                heartCheck.start();
            }
        }

        function reconnect(url) {
            if (lockReconnect) {
                return;
            }
            ;
            lockReconnect = true;
            //æ²¡è¿æ¥ä¸Šä¼šä¸€ç›´é‡è¿ï¼Œè®¾ç½®å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¤š
            tt && clearTimeout(tt);
            tt = setTimeout(function () {
                createWebSocket(url);
                lockReconnect = false;
            }, 4000);
        }

        //å¿ƒè·³æ£€æµ‹
        var heartCheck = {
            timeout: 3000,
            timeoutObj: null,
            serverTimeoutObj: null,
            start: function () {
                console.log('å¿ƒè·³ğŸ’æ£€æµ‹ä¸Šçº¿ï¼ï¼');
                var self = this;
                this.timeoutObj && clearTimeout(this.timeoutObj);
                this.serverTimeoutObj && clearTimeout(this.serverTimeoutObj);
                this.timeoutObj = setTimeout(function () {
                    //è¿™é‡Œå‘é€ä¸€ä¸ªå¿ƒè·³ï¼Œåç«¯æ”¶åˆ°åï¼Œè¿”å›ä¸€ä¸ªå¿ƒè·³æ¶ˆæ¯ï¼Œ
                    console.log('å‘é€ä¸€ä¸ªå¿ƒè·³ğŸ’“');
                    ws.send("123456789");
                    self.serverTimeoutObj = setTimeout(function () {
                        console.log(111);
                        console.log(ws);
                        if (ws == null) {
                            createWebSocket();
                        }
                    }, self.timeout);

                }, this.timeout)
            }
        }
        createWebSocket(wsUrl);

        //setInterval("showLogin()", "1000");

        //å°†æ¶ˆæ¯æ˜¾ç¤ºåœ¨ç½‘é¡µä¸Š
        function setMessageInnerHTML(innerHTML) {
            //ååºåˆ—åŒ–
            //var obj = JSON.parse(innerHTML);
            console.log(innerHTML);
            // msgs += innerHTML + "ã€‚<br/>";
            // if (document.getElementById("mssg") == null) {
            //     $("<div id='mssg' class=\"copyright dropdown-toggle\" style='padding: 0px'><i id='i' onclick=\"msgg()\"><img src=\"./images/common/msg.gif\"></i></div>").appendTo("#taskbar_right");
            // }
            // layim.getMessage({
            //     username: innerHTML.split("&")[0]
            //     , avatar: "./js/images/face/4.gif"
            //     , id: innerHTML.split(":::")[0].split("&")[1]
            //     , type: "friend"
            //     , content: innerHTML.split(":::")[1]
            //     , timestamp: new Date().getTime()
            // });
            layer.open({
                type:1,
                title:'ç´§æ€¥æ¶ˆæ¯',
                content:innerHTML,
                offset:['58%','66%'],
                area:['34%','38%'],
            })
        }

        //åŸºç¡€é…ç½®
        layim.config({
            brief: false //ç®€çº¦æ¨¡å¼ï¼Œä¸æ˜¾ç¤ºä¸»é¢æ¿
            , init: {
                // mine: {
                //     "username": G.user //æˆ‘çš„æ˜µç§°
                //     , "id": G.user //æˆ‘çš„ID
                //     , "status": "online" //åœ¨çº¿çŠ¶æ€ onlineï¼šåœ¨çº¿ã€hideï¼šéšèº«
                //     , "remark": G.user //æˆ‘çš„ç­¾å
                //     , "avatar": "../../js/images/face//4.gif" //æˆ‘çš„å¤´åƒ
                // }
                mine: {
                    "id": 3,
                    "username": G.user,
                    "avatar": "js/images/face/0.gif",
                    "sign": "æˆ‘çš„ç­¾å",
                    "status": "online"
                },
                friend: [{
                    "id": 1,
                    "groupname": "æˆ‘çš„å¥½å‹",
                    "list": [{
                        "id": 3,
                        "username": "æµ‹è¯•",
                        "avatar": "js/images/face/1.gif",
                        "sign": "æˆ‘çš„ç­¾å",
                        "status": "offline"
                    }, {
                        "id": 8,
                        "username": "å‘¨å…«",
                        "avatar": "js/images/face/2.gif",
                        "sign": null,
                        "status": "offline"
                    }, {
                        "id": 9,
                        "username": "å´ä¹",
                        "avatar": "js/images/face/4.gif",
                        "sign": null,
                        "status": "offline"
                    }]
                }],
                group: [{
                    "id": 1,
                    "groupname": "å“ˆå“ˆå“ˆ",
                    "avatar": "js/images/face/10.gif",
                    "members": null
                }]
            }
           // ,msgbox: 'message' //æ¶ˆæ¯ç›’å­é¡µé¢åœ°å€ï¼Œè‹¥ä¸å¼€å¯ï¼Œå‰”é™¤è¯¥é¡¹å³å¯

        });
        layim.on('tool(code)', function (insert) {
            layer.prompt({
                title: 'æ’å…¥ä»£ç '
                , formType: 2
                , shade: 0
            }, function (text, index) {
                layer.close(index);
                insert('[pre class=layui-code]' + text + '[/pre]'); //å°†å†…å®¹æ’å…¥åˆ°ç¼–è¾‘å™¨
            });
        });

        //ç›‘å¬layimå»ºç«‹å°±ç»ª
        layim.on('ready', function (res) {

            layim.msgbox(2); //æ¨¡æ‹Ÿæ¶ˆæ¯ç›’å­æœ‰æ–°æ¶ˆæ¯ï¼Œå®é™…ä½¿ç”¨æ—¶ï¼Œä¸€èˆ¬æ˜¯åŠ¨æ€è·å¾—

        });

        //ç›‘å¬å‘é€æ¶ˆæ¯
        layim.on('sendMessage', function (data) {
            var To = data.to;
            console.log(data);
            if (To.type === 'friend') {
                layim.setChatStatus('<span style="color:#FF5722;">å¯¹æ–¹æ­£åœ¨è¾“å…¥ã€‚ã€‚ã€‚</span>');
            }
            websocket.send(JSON.stringify(data));
            $.ajax({
                type: "post",
                url: "kss_process/send",    //è¯·æ±‚å‘é€åˆ°
                data: {"msg": JSON.stringify(data)},
                dataType: "json",        //è¿”å›æ•°æ®å½¢å¼ä¸ºjson
                success: function (result) {

                },
                error: function (errorMsg) {
                    $.messager.alert('æç¤º', 'å‘é€å¤±è´¥', 'info');
                }
            });
        });
    });

    function msgg() {
        layer.msg(msgs, {
            time: 200000, //200såè‡ªåŠ¨å…³é—­
            btn: ['çŸ¥é“äº†']
        });
        $("#mssg").remove();
        msgs = '';    //å½“ç”¨æˆ·æŸ¥çœ‹æ¶ˆæ¯åç½®ç©ºæ¶ˆæ¯å®¹å™¨
    }

</script>
<script type="text/javascript">
    G.this_path = G.my_desktop;
    seajs.config({
        base: "./js/",
        preload: ["lib/jquery-1.8.0.min"],
        map: [
            [/^(.*\.(?:css|js))(.*)$/i, '$1$2?ver=' + G.version]
        ]
    });
    seajs.use("app/src/desktop/main");
</script>
</body>
<style type="text/css">

</style>
</html>
